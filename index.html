<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹æœºå·ç ç›‘æ§å¹³å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-found { color: #28a745; font-weight: bold; }
        .status-not-found { color: #dc3545; }
        .status-checking { color: #ffc107; }
        .platform-card { transition: all 0.3s ease; }
        .platform-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .last-update { font-size: 0.9em; color: #6c757d; }
        .auto-refresh-toggle { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .card { margin-bottom: 10px; }
            .auto-refresh-toggle { position: relative; top: auto; right: auto; margin: 10px 0; }
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <header class="text-center mb-4">
            <h1 class="display-4">ğŸ“± æ‰‹æœºå·ç ç›‘æ§å¹³å°</h1>
            <p class="lead">å®æ—¶ç›‘æ§å¤šä¸ªå·ç å¹³å°çš„å·ç çŠ¶æ€</p>
        </header>

        <main>
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">ç›®æ ‡å·ç </span>
                        <input type="tel" id="targetPhone" class="form-control" placeholder="è¾“å…¥11ä½æ‰‹æœºå·" value="16609526106">
                        <button class="btn btn-primary" onclick="startMonitoring()">å¼€å§‹ç›‘æ§</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">åˆ·æ–°é—´éš”</span>
                        <select id="interval" class="form-select">
                            <option value="30">30ç§’</option>
                            <option value="60" selected>1åˆ†é’Ÿ</option>
                            <option value="300">5åˆ†é’Ÿ</option>
                        </select>
                        <button class="btn btn-outline-secondary" onclick="toggleAutoRefresh()">
                            <span id="refreshIcon">â–¶ï¸</span> è‡ªåŠ¨åˆ·æ–°
                        </button>
                    </div>
                </div>
            </div>

            <div class="row" id="platformsContainer">
                <!-- å¹³å°å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="text-center mt-4">
                <p class="last-update">æœ€åæ›´æ–°: <span id="lastUpdate">--</span></p>
                <button class="btn btn-success btn-lg" onclick="checkAllPlatforms()">ğŸ”„ ç«‹å³æ£€æŸ¥æ‰€æœ‰å¹³å°</button>
            </div>
        </main>
    </div>

    <script>
        const platforms = {
            "å·ç ä¹‹å®¶-ç²¾ç¡®": "https://www.1778.com/xuanhao?source=007159&dis=yueyang&exactword={phone}",
            "å·ç ä¹‹å®¶-æ¨¡ç³Š": "https://www.1778.com/xuanhao?source=007159&dis=yueyang&gs=1&keyword={phone}",
            "è´­å·ç½‘": "https://xn.gouhaowang.cn/search?keyword={phone}",
            "æ–°å¹³å°-å·ç ç½‘": "https://haoma.com/xh/?dis=1&keywords={phone}&qg=1"
        };

        let autoRefreshInterval = null;
        let isAutoRefreshing = false;

        // åˆå§‹åŒ–å¹³å°å¡ç‰‡
        function initializePlatforms() {
            const container = document.getElementById('platformsContainer');
            container.innerHTML = '';
            
            for (const [name, url] of Object.entries(platforms)) {
                const card = `
                    <div class="col-md-6 col-lg-3 mb-3">
                        <div class="card platform-card h-100" data-platform="${name}">
                            <div class="card-header">
                                <h6 class="card-title mb-0">${name}</h6>
                            </div>
                            <div class="card-body">
                                <div class="status-display">
                                    <span class="badge bg-secondary">ç­‰å¾…æ£€æŸ¥</span>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted url-display">${url.replace('{phone}', '...')}</small>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-sm btn-outline-primary w-100" onclick="checkSinglePlatform('${name}')">
                                    æ£€æŸ¥çŠ¶æ€
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            }
        }

        // æ£€æŸ¥å•ä¸ªå¹³å°
        async function checkSinglePlatform(platformName) {
            const phone = document.getElementById('targetPhone').value;
            const url = platforms[platformName].replace('{phone}', phone);
            const card = document.querySelector(`[data-platform="${platformName}"]`);
            const statusDisplay = card.querySelector('.status-display');
            
            statusDisplay.innerHTML = '<span class="badge bg-warning status-checking">æ£€æŸ¥ä¸­...</span>';
            
            try {
                const proxyUrl = `http://localhost:3000/proxy?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                const html = await response.text();
                
                const result = analyzePlatform(html, phone, platformName);
                
                if (result.found) {
                    statusDisplay.innerHTML = `<span class="badge bg-success status-found">âœ… ${result.number}</span>`;
                    // å¯ä»¥æ·»åŠ é€šçŸ¥åŠŸèƒ½
                    if (Notification.permission === "granted") {
                        new Notification("å·ç æ‰¾åˆ°ï¼", {
                            body: `${platformName} æ‰¾åˆ°äº†å·ç  ${result.number}`,
                            icon: "https://via.placeholder.com/100"
                        });
                    }
                } else {
                    statusDisplay.innerHTML = '<span class="badge bg-danger status-not-found">âŒ æœªæ‰¾åˆ°</span>';
                }
            } catch (error) {
                statusDisplay.innerHTML = '<span class="badge bg-danger">âŒ æ£€æŸ¥å¤±è´¥</span>';
            }
            
            updateLastUpdateTime();
        }

        // åˆ†æå¹³å°å†…å®¹ï¼ˆç®€åŒ–ç‰ˆåˆ†æé€»è¾‘ï¼‰
        function analyzePlatform(html, phone, platformName) {
            if (platformName.includes("1778")) {
                // 1778.com çš„åˆ†æé€»è¾‘
                const numberMatch = html.match(/<span class="number">(\d+)<\/span>/g);
                if (numberMatch) {
                    const numbers = numberMatch.map(match => match.replace(/<[^>]*>/g, ''));
                    const found = numbers.find(n => n === phone);
                    return { found: !!found, number: found || null };
                }
            } else if (platformName.includes("haoma")) {
                // haoma.com çš„åˆ†æé€»è¾‘
                const cleanHtml = html.replace(/-/g, '');
                return { found: cleanHtml.includes(phone), number: phone };
            } else {
                // å…¶ä»–å¹³å°çš„é€šç”¨åˆ†æ
                const hasNumber = html.includes(phone.substring(0, 7)) || html.includes(phone.substring(-4));
                return { found: hasNumber, number: phone };
            }
            return { found: false, number: null };
        }

        // æ£€æŸ¥æ‰€æœ‰å¹³å°
        async function checkAllPlatforms() {
            for (const platformName of Object.keys(platforms)) {
                await checkSinglePlatform(platformName);
                await new Promise(resolve => setTimeout(resolve, 500)); // é¿å…è¯·æ±‚è¿‡å¿«
            }
        }

        // å¼€å§‹ç›‘æ§
        function startMonitoring() {
            checkAllPlatforms();
            if (!isAutoRefreshing) {
                toggleAutoRefresh();
            }
        }

        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            const icon = document.getElementById('refreshIcon');
            const interval = document.getElementById('interval').value * 1000;
            
            if (isAutoRefreshing) {
                clearInterval(autoRefreshInterval);
                icon.textContent = 'â–¶ï¸';
                isAutoRefreshing = false;
            } else {
                autoRefreshInterval = setInterval(checkAllPlatforms, interval);
                icon.textContent = 'â¸ï¸';
                isAutoRefreshing = true;
            }
        }

        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
        }

        // è¯·æ±‚é€šçŸ¥æƒé™
        if ("Notification" in window && Notification.permission === "default") {
            Notification.requestPermission();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializePlatforms();
            updateLastUpdateTime();
        });
    </script>
</body>
</html>
